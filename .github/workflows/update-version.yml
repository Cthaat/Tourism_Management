name: è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·

# å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘å·¥ä½œæµ
on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0, v2.1.3 ç­‰ç‰ˆæœ¬æ ‡ç­¾æ ¼å¼

jobs:
  update-version:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.WECHAT_TOKEN }}

    # 2. è®¾ç½®Node.jsç¯å¢ƒ
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # 3. æå–ç‰ˆæœ¬å·ï¼ˆä»æ ‡ç­¾ä¸­å»æ‰'v'å‰ç¼€ï¼‰
    - name: æå–ç‰ˆæœ¬å·
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "æå–åˆ°çš„ç‰ˆæœ¬å·: $VERSION"

    # 4. æ›´æ–°version.jsæ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·
    - name: æ›´æ–°version.jsç‰ˆæœ¬å·
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        VERSION_FILE="miniprogram/config/version.js"
        
        # ä½¿ç”¨sedå‘½ä»¤æ›¿æ¢ç‰ˆæœ¬å·
        sed -i "s/version: '[^']*'/version: '$VERSION'/g" $VERSION_FILE
        
        # æ›´æ–°æ–‡ä»¶å¤´éƒ¨çš„ç‰ˆæœ¬æ³¨é‡Š
        sed -i "s/@version [0-9]*\.[0-9]*\.[0-9]*/@version $VERSION/g" $VERSION_FILE
        
        echo "å·²æ›´æ–°version.jsæ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·ä¸º: $VERSION"
        
        # æ˜¾ç¤ºæ›´æ”¹å†…å®¹
        echo "=== version.js æ›´æ”¹å†…å®¹ ==="
        cat $VERSION_FILE | grep -E "(version:|@version)" | head -10

    # 5. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
    - name: å®‰è£…ä¾èµ–
      run: |
        if [ -f package.json ]; then
          npm install
        fi

    # 6. æ‰§è¡ŒREADMEæ›´æ–°è„šæœ¬
    - name: æ›´æ–°README.mdç‰ˆæœ¬å·
      run: |
        cd scripts
        node update-readme-version.js
        echo "README.mdç‰ˆæœ¬å·æ›´æ–°å®Œæˆ"

    # 7. æäº¤æ›´æ”¹
    - name: æäº¤ç‰ˆæœ¬æ›´æ–°
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ›´æ”¹çš„æ–‡ä»¶
        git add miniprogram/config/version.js README.md
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
        else
          git commit -m "ğŸ”– è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·åˆ° v${{ steps.get_version.outputs.VERSION }}"
          
          # æ¨é€åˆ°ä¸»åˆ†æ”¯
          git push origin HEAD:master
          git push wechat HEAD:master
          
          echo "ç‰ˆæœ¬æ›´æ–°å·²æäº¤å¹¶æ¨é€"
        fi

    # 8. åˆ›å»ºGitHub Releaseï¼ˆå¯é€‰ï¼‰
    - name: åˆ›å»ºGitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.WECHAT_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: æ—…æ¸¸æ¨èå°ç¨‹åº v${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ğŸ‰ ç‰ˆæœ¬ v${{ steps.get_version.outputs.VERSION }} å‘å¸ƒ

          ### ğŸ”„ è‡ªåŠ¨æ›´æ–°å†…å®¹
          - âœ… æ›´æ–° `miniprogram/config/version.js` ç‰ˆæœ¬å·
          - âœ… æ›´æ–° `README.md` ç‰ˆæœ¬å¾½ç« 
          - âœ… åŒæ­¥æ‰€æœ‰ç‰ˆæœ¬ä¿¡æ¯

          ### ğŸ“‹ å®Œæ•´æ›´æ–°æ—¥å¿—
          è¯·æŸ¥çœ‹æäº¤è®°å½•äº†è§£è¯¦ç»†æ›´æ”¹å†…å®¹ã€‚

          ---
          *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨å‘å¸ƒ*
        draft: false
        prerelease: false

    # 9. é€šçŸ¥å®ŒæˆçŠ¶æ€
    - name: è¾“å‡ºå®Œæˆä¿¡æ¯
      run: |
        echo "ğŸ‰ ç‰ˆæœ¬æ›´æ–°å·¥ä½œæµå®Œæˆï¼"
        echo "ğŸ“Œ ç‰ˆæœ¬å·: v${{ steps.get_version.outputs.VERSION }}"
        echo "ğŸ“ æ›´æ–°çš„æ–‡ä»¶:"
        echo "   - miniprogram/config/version.js"
        echo "   - README.md"
        echo "ğŸš€ GitHub Release å·²åˆ›å»º"
