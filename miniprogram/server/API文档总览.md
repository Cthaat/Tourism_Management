# æ—…æ¸¸ç®¡ç†å¾®ä¿¡å°ç¨‹åºAPIæ–‡æ¡£æ€»è§ˆ

## ğŸ“š æ–‡æ¡£ç´¢å¼•

æœ¬é¡¹ç›®ä¸ºæ—…æ¸¸ç®¡ç†å¾®ä¿¡å°ç¨‹åºæä¾›äº†å®Œæ•´çš„åç«¯APIæ”¯æŒï¼ŒåŒ…å«è¯„è®ºç®¡ç†ã€æ™¯ç‚¹ç®¡ç†ã€ç”¨æˆ·ç³»ç»Ÿã€å›¾ç‰‡å¤„ç†ç­‰æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ã€‚

---

## ğŸ—ï¸ æ ¸å¿ƒAPIæ¨¡å—

### 1. è¯„è®ºç®¡ç†API (`CommentApi.js`)
**åŠŸèƒ½**: æ™¯ç‚¹è¯„è®ºçš„å®Œæ•´CRUDæ“ä½œï¼Œæ”¯æŒè¯„åˆ†ã€å›å¤ã€å®¡æ ¸ç­‰åŠŸèƒ½

**ä¸»è¦æ–¹æ³•**:
- `addComment()` - æ·»åŠ è¯„è®º
- `updateComment()` - æ›´æ–°è¯„è®º  
- `deleteComment()` - åˆ é™¤è¯„è®º
- `getComment()` - è·å–å•æ¡è¯„è®º
- `listComments()` - è·å–è¯„è®ºåˆ—è¡¨
- `listCommentsBySpot()` - è·å–æ™¯ç‚¹è¯„è®º
- `testConnection()` - æµ‹è¯•è¿æ¥

**æ–‡æ¡£é“¾æ¥**: 
- [ğŸ“– è¯„è®ºç®¡ç†APIä½¿ç”¨æŒ‡å—](./è¯„è®ºç®¡ç†APIä½¿ç”¨æŒ‡å—.md)
- [âš¡ è¯„è®ºåŠŸèƒ½å¿«é€Ÿé›†æˆæŒ‡å—](./è¯„è®ºåŠŸèƒ½å¿«é€Ÿé›†æˆæŒ‡å—.md)

---

### 2. æ™¯ç‚¹ç®¡ç†API (`SpotManageApi.js`)
**åŠŸèƒ½**: æ™¯ç‚¹ä¿¡æ¯çš„å®Œæ•´ç®¡ç†ï¼ŒåŒ…å«åŸºç¡€ä¿¡æ¯ã€ä½ç½®æœåŠ¡ã€çŠ¶æ€ç®¡ç†ã€é«˜çº§æœç´¢ç­‰

**ä¸»è¦æ–¹æ³•**:
- `addSpot()` - æ·»åŠ æ™¯ç‚¹
- `updateSpot()` - æ›´æ–°æ™¯ç‚¹ä¿¡æ¯
- `deleteSpot()` - åˆ é™¤æ™¯ç‚¹
- `getSpot()` - è·å–æ™¯ç‚¹è¯¦æƒ…
- `getSpotList()` - è·å–æ™¯ç‚¹åˆ—è¡¨
- `searchSpot()` - æœç´¢æ™¯ç‚¹ï¼ˆNEW v2.1.0ï¼‰
- `testConnection()` - æµ‹è¯•äº‘å‡½æ•°è¿æ¥ï¼ˆNEW v2.1.0ï¼‰
- `validateSpotData()` - æ•°æ®éªŒè¯

**æœç´¢åŠŸèƒ½ç‰¹æ€§**:
- ğŸ” å…³é”®è¯æœç´¢ï¼ˆåç§°ã€åœ°å€ï¼‰
- ğŸ“ åœ°ç†ä½ç½®ç­›é€‰ï¼ˆçœä»½ã€åŸå¸‚ï¼‰
- ğŸ’° ä»·æ ¼åŒºé—´ç­›é€‰
- â­ è¯„åˆ†èŒƒå›´ç­›é€‰
- ğŸ·ï¸ åˆ†ç±»æ ‡ç­¾ç­›é€‰
- ğŸ“„ åˆ†é¡µå’Œæ’åºæ”¯æŒ
- ğŸ”„ å¤šç§æœç´¢æ–¹å¼è‡ªåŠ¨å›é€€

**æ–‡æ¡£é“¾æ¥**:
- [ğŸ“– æ™¯ç‚¹ç®¡ç†APIä½¿ç”¨æŒ‡å—](./æ™¯ç‚¹ç®¡ç†APIä½¿ç”¨æŒ‡å—.md)
- [âš¡ æ™¯ç‚¹ç®¡ç†åŠŸèƒ½å¿«é€Ÿé›†æˆæŒ‡å—](./æ™¯ç‚¹ç®¡ç†åŠŸèƒ½å¿«é€Ÿé›†æˆæŒ‡å—.md)
- [ğŸ” æ™¯ç‚¹æœç´¢åŠŸèƒ½ä½¿ç”¨æŒ‡å—](../docs/æ™¯ç‚¹æœç´¢åŠŸèƒ½ä½¿ç”¨æŒ‡å—.md)

---

### 3. ç”¨æˆ·ç™»å½•API (`UserLoginApi.js`)
**åŠŸèƒ½**: ç”¨æˆ·è®¤è¯ä¸ç™»å½•ç®¡ç†ï¼Œæ”¯æŒå¾®ä¿¡ç™»å½•å’Œæœ¬åœ°fallback

**ä¸»è¦æ–¹æ³•**:
- `login()` - ç”¨æˆ·ç™»å½•
- `getUserInfo()` - è·å–ç”¨æˆ·ä¿¡æ¯
- `updateUserSession()` - æ›´æ–°ä¼šè¯
- `logout()` - ç”¨æˆ·ç™»å‡º
- `checkLoginStatus()` - æ£€æŸ¥ç™»å½•çŠ¶æ€

**æ–‡æ¡£é“¾æ¥**:
- [ğŸ“– ç”¨æˆ·ç™»å½•APIä½¿ç”¨æŒ‡å—](./ç”¨æˆ·ç™»å½•APIä½¿ç”¨æŒ‡å—.md)

---

### 4. ç”¨æˆ·èµ„æ–™API (`UserUpdate.js`)
**åŠŸèƒ½**: ç”¨æˆ·èµ„æ–™ç®¡ç†ï¼ŒåŒ…å«ä¸ªäººä¿¡æ¯æ›´æ–°ã€å¤´åƒä¸Šä¼ ç­‰

**ä¸»è¦æ–¹æ³•**:
- `updateUserProfile()` - æ›´æ–°ç”¨æˆ·èµ„æ–™
- `uploadAvatar()` - ä¸Šä¼ ç”¨æˆ·å¤´åƒ
- `getUserProfile()` - è·å–ç”¨æˆ·èµ„æ–™
- `deleteUserData()` - åˆ é™¤ç”¨æˆ·æ•°æ®

**æ–‡æ¡£é“¾æ¥**:
- [ğŸ“– ç”¨æˆ·èµ„æ–™æ›´æ–°APIä½¿ç”¨æŒ‡å—](./ç”¨æˆ·èµ„æ–™æ›´æ–°APIä½¿ç”¨æŒ‡å—.md)

---

### 5. å›¾ç‰‡ç®¡ç†API (`ImageApi.js`)
**åŠŸèƒ½**: ç»Ÿä¸€çš„å›¾ç‰‡ä¸Šä¼ ã€å­˜å‚¨ã€æŸ¥è¯¢å’Œåˆ é™¤åŠŸèƒ½ï¼Œä¸“ä¸ºæ™¯ç‚¹è½®æ’­å›¾è®¾è®¡

**ä¸»è¦æ–¹æ³•**:
- `uploadSpotImages()` - ä¸Šä¼ æ™¯ç‚¹å›¾ç‰‡
- `getSpotImages()` - è·å–æ™¯ç‚¹è½®æ’­å›¾
- `deleteImage()` - åˆ é™¤å›¾ç‰‡
- `getSpotMainImage()` - è·å–æ™¯ç‚¹ä¸»å›¾
- `preloadSpotImages()` - æ‰¹é‡é¢„åŠ è½½å›¾ç‰‡
- `validateImageFile()` - å›¾ç‰‡æ–‡ä»¶éªŒè¯

**æ–‡æ¡£é“¾æ¥**:
- [ğŸ“– å›¾ç‰‡ç®¡ç†APIä½¿ç”¨æŒ‡å—](./å›¾ç‰‡ç®¡ç†APIä½¿ç”¨æŒ‡å—.md)
- [âš¡ å›¾ç‰‡ç®¡ç†åŠŸèƒ½å¿«é€Ÿé›†æˆæŒ‡å—](./å›¾ç‰‡ç®¡ç†åŠŸèƒ½å¿«é€Ÿé›†æˆæŒ‡å—.md)

---

## ğŸ”§ äº‘å‡½æ•°æ”¯æŒ

### ä¸»è¦äº‘å‡½æ•°

1. **spotManage** - æ™¯ç‚¹ç®¡ç†ä¸“ç”¨äº‘å‡½æ•° âœ¨NEW
   - æ”¯æŒæ™¯ç‚¹æ•°æ®çš„CRUDæ“ä½œ
   - é«˜çº§æœç´¢åŠŸèƒ½ï¼ˆå…³é”®è¯ã€åˆ†ç±»ã€ä»·æ ¼ã€è¯„åˆ†ç­›é€‰ï¼‰
   - å¤šç§æœç´¢æ–¹å¼è‡ªåŠ¨å›é€€æœºåˆ¶
   - äº‘å‡½æ•°è¿æ¥çŠ¶æ€æµ‹è¯•
   - åŸºäº@cloudbase/node-sdké‡æ„

2. **commonManager** - é€šç”¨æ•°æ®ç®¡ç†
   - æ”¯æŒæ™¯ç‚¹æ•°æ®çš„CRUDæ“ä½œ
   - è¯„è®ºæ•°æ®ç®¡ç†
   - ç»Ÿè®¡æŸ¥è¯¢åŠŸèƒ½

2. **uploadPicture** - å›¾ç‰‡å¤„ç†ä¸“ç”¨
   - å›¾ç‰‡è®°å½•ä¿å­˜
   - äº‘å­˜å‚¨æ–‡ä»¶åˆ é™¤
   - æ™¯ç‚¹å›¾ç‰‡æŸ¥è¯¢

3. **userLogin** - ç”¨æˆ·è®¤è¯
   - å¾®ä¿¡ç™»å½•å¤„ç†
   - ç”¨æˆ·ä¿¡æ¯ç®¡ç†

4. **updateProfile** - ç”¨æˆ·èµ„æ–™æ›´æ–°
   - ä¸ªäººä¿¡æ¯æ›´æ–°
   - å¤´åƒä¸Šä¼ å¤„ç†

---

## ğŸ“‹ æ•°æ®åº“é›†åˆ

### ä¸»è¦æ•°æ®è¡¨

1. **spot_common** - æ™¯ç‚¹ä¿¡æ¯è¡¨
   - åŸºç¡€ä¿¡æ¯: åç§°ã€æè¿°ã€ä½ç½®
   - æ‰©å±•ä¿¡æ¯: å¼€æ”¾æ—¶é—´ã€é—¨ç¥¨ä»·æ ¼
   - çŠ¶æ€ç®¡ç†: å®¡æ ¸çŠ¶æ€ã€å¯è§æ€§

2. **comment_common** - è¯„è®ºæ•°æ®è¡¨
   - è¯„è®ºå†…å®¹å’Œè¯„åˆ†
   - ç”¨æˆ·å…³è”ä¿¡æ¯
   - å®¡æ ¸çŠ¶æ€ç®¡ç†

3. **image_common** - å›¾ç‰‡è®°å½•è¡¨
   - å›¾ç‰‡URLå’Œæ–‡ä»¶ID
   - å…³è”æ™¯ç‚¹ä¿¡æ¯
   - ä¸Šä¼ æ—¶é—´è®°å½•

4. **user_profiles** - ç”¨æˆ·èµ„æ–™è¡¨
   - åŸºç¡€ä¿¡æ¯å’Œåå¥½è®¾ç½®
   - å¤´åƒå’Œè”ç³»æ–¹å¼
   - éšç§è®¾ç½®

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€é…ç½®

```javascript
// åœ¨app.jsä¸­åˆå§‹åŒ–äº‘å¼€å‘
App({
  onLaunch() {
    if (!wx.cloud) {
      console.error('è¯·ä½¿ç”¨ 2.2.3 æˆ–ä»¥ä¸Šçš„åŸºç¡€åº“ä»¥ä½¿ç”¨äº‘èƒ½åŠ›')
    } else {
      wx.cloud.init({
        env: 'your-env-id',  // æ›¿æ¢ä¸ºä½ çš„äº‘ç¯å¢ƒID
        traceUser: true
      })
    }
  }
})
```

### 2. å¯¼å…¥APIæ¨¡å—

```javascript
// åœ¨é¡µé¢ä¸­å¯¼å…¥éœ€è¦çš„API
const CommentApi = require('../../server/CommentApi.js')
const SpotManageApi = require('../../server/SpotManageApi.js')
const ImageApi = require('../../server/ImageApi.js')
const UserLoginApi = require('../../server/UserLoginApi.js')
```

### 3. åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹

```javascript
Page({
  async onLoad() {
    try {
      // æµ‹è¯•äº‘å‡½æ•°è¿æ¥
      const connectionTest = await SpotManageApi.testConnection()
      if (!connectionTest.success) {
        console.warn('äº‘å‡½æ•°è¿æ¥å¼‚å¸¸:', connectionTest.message)
      }
      
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      const isLoggedIn = await UserLoginApi.checkLoginStatus()
      
      if (!isLoggedIn) {
        // æ‰§è¡Œç™»å½•
        await UserLoginApi.login()
      }
      
      // åŠ è½½æ™¯ç‚¹åˆ—è¡¨
      const spots = await SpotManageApi.getSpotList()
      
      // ä¸ºæ¯ä¸ªæ™¯ç‚¹åŠ è½½ä¸»å›¾
      for (const spot of spots.data) {
        spot.mainImage = await ImageApi.getSpotMainImage(spot.id)
      }
      
      this.setData({ spotList: spots.data })
    } catch (error) {
      console.error('åˆå§‹åŒ–å¤±è´¥:', error)
    }
  },

  // æœç´¢åŠŸèƒ½ç¤ºä¾‹
  async onSearch(keyword) {
    try {
      // ä½¿ç”¨æœç´¢API
      const searchResult = await SpotManageApi.searchSpot({
        keyword: keyword,
        minRating: 4.0,  // åªæ˜¾ç¤ºé«˜è¯„åˆ†æ™¯ç‚¹
        status: true,    // åªæ˜¾ç¤ºå¯ç”¨æ™¯ç‚¹
        page: 1,
        limit: 20,
        sortBy: 'rating',
        sortOrder: 'desc'
      })

      if (searchResult.success) {
        console.log('æœç´¢æ–¹å¼:', searchResult.searchType)
        
        // åŠ è½½æœç´¢ç»“æœçš„å›¾ç‰‡
        for (const spot of searchResult.data) {
          spot.mainImage = await ImageApi.getSpotMainImage(spot._id)
        }
        
        this.setData({
          spotList: searchResult.data,
          searchTotal: searchResult.total,
          hasMore: searchResult.page * searchResult.limit < searchResult.total
        })
      } else {
        wx.showToast({
          title: searchResult.message,
          icon: 'none'
        })
      }
    } catch (error) {
      console.error('æœç´¢å¤±è´¥:', error)
    }
  }
})
```

---

## ğŸ” ä½¿ç”¨å»ºè®®

### 1. å¼€å‘æµç¨‹å»ºè®®

1. **é˜…è¯»å¯¹åº”APIçš„ä½¿ç”¨æŒ‡å—** - äº†è§£å®Œæ•´åŠŸèƒ½å’Œå‚æ•°
2. **æŸ¥çœ‹å¿«é€Ÿé›†æˆæŒ‡å—** - è·å–å®Œæ•´çš„é¡µé¢å®ç°ç¤ºä¾‹
3. **å‚è€ƒæµ‹è¯•ä»£ç ** - äº†è§£æœ€ä½³å®è·µå’Œé”™è¯¯å¤„ç†
4. **è¿›è¡ŒåŠŸèƒ½æµ‹è¯•** - ä½¿ç”¨æä¾›çš„æµ‹è¯•æ–¹æ³•éªŒè¯é›†æˆ

### 2. é”™è¯¯å¤„ç†æ¨¡å¼

```javascript
try {
  const result = await SomeApi.someMethod(params)
  if (result.success) {
    // å¤„ç†æˆåŠŸç»“æœ
  } else {
    // å¤„ç†ä¸šåŠ¡å¤±è´¥
    wx.showToast({ title: result.message, icon: 'none' })
  }
} catch (error) {
  // å¤„ç†å¼‚å¸¸é”™è¯¯
  console.error('æ“ä½œå¤±è´¥:', error)
  wx.showToast({ title: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', icon: 'none' })
}
```

### 3. æ€§èƒ½ä¼˜åŒ–å»ºè®®

- **å¹¶å‘æ§åˆ¶**: å¤§é‡æ•°æ®æ“ä½œæ—¶ä½¿ç”¨å¹¶å‘é™åˆ¶
- **ç¼“å­˜ç­–ç•¥**: åˆç†ç¼“å­˜å¸¸ç”¨æ•°æ®å‡å°‘ç½‘ç»œè¯·æ±‚
- **æ‡’åŠ è½½**: åˆ—è¡¨é¡µé¢ä½¿ç”¨å›¾ç‰‡æ‡’åŠ è½½
- **æ•°æ®åˆ†é¡µ**: å¤§é‡æ•°æ®ä½¿ç”¨åˆ†é¡µåŠ è½½

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¸¸è§é—®é¢˜

1. **äº‘å‡½æ•°è°ƒç”¨å¤±è´¥**
   - æ£€æŸ¥äº‘å‡½æ•°æ˜¯å¦æ­£ç¡®éƒ¨ç½²
   - ç¡®è®¤äº‘ç¯å¢ƒIDé…ç½®æ­£ç¡®
   - æŸ¥çœ‹ç½‘ç»œè¿æ¥çŠ¶æ€

2. **æ•°æ®åº“æ“ä½œå¼‚å¸¸**
   - ç¡®è®¤æ•°æ®åº“æƒé™é…ç½®
   - æ£€æŸ¥æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®
   - éªŒè¯å¿…éœ€å­—æ®µæ˜¯å¦å®Œæ•´

3. **å›¾ç‰‡ä¸Šä¼ å¤±è´¥**
   - æ£€æŸ¥æ–‡ä»¶å¤§å°å’Œæ ¼å¼
   - ç¡®è®¤äº‘å­˜å‚¨æƒé™è®¾ç½®
   - éªŒè¯ç½‘ç»œè¿æ¥ç¨³å®šæ€§

### è°ƒè¯•æŠ€å·§

```javascript
// å¯ç”¨è¯¦ç»†æ—¥å¿—
console.log('=== APIè°ƒç”¨å¼€å§‹ ===')
const result = await SomeApi.someMethod(params)
console.log('=== APIè°ƒç”¨ç»“æœ ===', result)

// æµ‹è¯•è¿æ¥çŠ¶æ€
const connectionTest = await SomeApi.testConnection()
console.log('è¿æ¥æµ‹è¯•:', connectionTest)
```

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **v2.1.0** (2025-05-31): æ–°å¢æ™¯ç‚¹æœç´¢åŠŸèƒ½ï¼Œæ”¯æŒå¤šç»´åº¦æœç´¢å’Œæ™ºèƒ½å›é€€æœºåˆ¶
- **v2.0.0** (2025-05-27): å®Œæˆæ‰€æœ‰æ ¸å¿ƒAPIæ¨¡å—ï¼Œæä¾›å®Œæ•´æ–‡æ¡£
- **v1.5.0** (2025-05-26): æ·»åŠ å›¾ç‰‡ç®¡ç†åŠŸèƒ½ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
- **v1.0.0** (2025-05-25): åˆå§‹ç‰ˆæœ¬ï¼Œæä¾›åŸºç¡€APIåŠŸèƒ½

---

**é¡¹ç›®ä½œè€…**: é«˜çº§ä¸­å›½å…¨æ ˆå·¥ç¨‹å¸ˆ  
**æ–‡æ¡£æ›´æ–°**: 2025å¹´5æœˆ31æ—¥  
**æŠ€æœ¯æ ˆ**: å¾®ä¿¡å°ç¨‹åº + äº‘å¼€å‘ + JavaScript

å¦‚éœ€æ›´è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜ï¼Œè¯·æŸ¥çœ‹å„ä¸ªAPIçš„ä¸“é—¨æ–‡æ¡£ã€‚
