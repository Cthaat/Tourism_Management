# å›¾ç‰‡ç®¡ç†åŠŸèƒ½å¿«é€Ÿé›†æˆæŒ‡å—

## ğŸ¯ å¿«é€Ÿå¼€å§‹ - 5åˆ†é’Ÿé›†æˆæ™¯ç‚¹è½®æ’­å›¾

æœ¬æŒ‡å—å¸®åŠ©æ‚¨å¿«é€Ÿåœ¨é¡µé¢ä¸­é›†æˆå›¾ç‰‡ä¸Šä¼ ã€æ˜¾ç¤ºå’Œç®¡ç†åŠŸèƒ½ã€‚

## ğŸ“¦ ç¬¬ä¸€æ­¥ï¼šå¯¼å…¥API

åœ¨éœ€è¦ä½¿ç”¨å›¾ç‰‡åŠŸèƒ½çš„é¡µé¢JSæ–‡ä»¶ä¸­å¯¼å…¥ï¼š

```javascript
const ImageApi = require('../../server/ImageApi.js')
```

## ğŸ–¼ï¸ ç¬¬äºŒæ­¥ï¼šé¡µé¢æ¨¡æ¿ç¤ºä¾‹

### æ™¯ç‚¹å‘å¸ƒé¡µé¢ (add-spot.wxml)

```xml
<view class="image-section">
  <view class="section-title">æ™¯ç‚¹å›¾ç‰‡ (æœ€å¤š9å¼ )</view>
  
  <!-- å·²é€‰æ‹©çš„å›¾ç‰‡é¢„è§ˆ -->
  <view class="selected-images" wx:if="{{selectedImages.length > 0}}">
    <view class="image-item" wx:for="{{selectedImages}}" wx:key="index">
      <image src="{{item.tempFilePath}}" mode="aspectFill"></image>
      <view class="remove-btn" bindtap="removeImage" data-index="{{index}}">Ã—</view>
    </view>
  </view>
  
  <!-- é€‰æ‹©å›¾ç‰‡æŒ‰é’® -->
  <view class="choose-image-btn" bindtap="chooseImages" wx:if="{{selectedImages.length < 9}}">
    <text class="iconfont icon-camera"></text>
    <text>é€‰æ‹©å›¾ç‰‡</text>
  </view>
  
  <!-- ä¸Šä¼ æŒ‰é’® -->
  <button class="upload-btn" bindtap="uploadImages" 
          disabled="{{!selectedImages.length || !spotId}}">
    ä¸Šä¼ å›¾ç‰‡ ({{selectedImages.length}}/9)
  </button>
  
  <!-- å·²ä¸Šä¼ çš„å›¾ç‰‡å±•ç¤º -->
  <view class="uploaded-images" wx:if="{{spotImages.length > 0}}">
    <view class="section-title">å·²ä¸Šä¼ å›¾ç‰‡ ({{spotImages.length}}å¼ )</view>
    <view class="image-grid">
      <view class="uploaded-item" wx:for="{{spotImages}}" wx:key="index">
        <image src="{{item}}" mode="aspectFill" bindtap="previewImage" data-urls="{{spotImages}}" data-current="{{item}}"></image>
        <view class="delete-btn" bindtap="deleteImage" data-fileid="{{item}}">åˆ é™¤</view>
      </view>
    </view>
  </view>
</view>
```

### æ™¯ç‚¹è¯¦æƒ…é¡µé¢è½®æ’­å›¾ (spot-detail.wxml)

```xml
<view class="spot-detail">
  <!-- è½®æ’­å›¾ -->
  <swiper class="spot-swiper" indicator-dots="{{swiperImages.length > 1}}" 
          circular="{{swiperImages.length > 1}}" autoplay="{{swiperImages.length > 1}}">
    <swiper-item wx:for="{{swiperImages}}" wx:key="index">
      <image src="{{item}}" mode="aspectFill" class="swiper-image" 
             bindtap="previewImage" data-urls="{{swiperImages}}" data-current="{{item}}"></image>
    </swiper-item>
  </swiper>
  
  <!-- å›¾ç‰‡è®¡æ•° -->
  <view class="image-count" wx:if="{{swiperImages.length > 1}}">
    {{currentImageIndex + 1}}/{{swiperImages.length}}
  </view>
</view>
```

### æ™¯ç‚¹åˆ—è¡¨é¡µé¢ä¸»å›¾ (spot-list.wxml)

```xml
<view class="spot-list">
  <view class="spot-item" wx:for="{{spotList}}" wx:key="id">
    <view class="spot-image-container">
      <image src="{{item.mainImage}}" mode="aspectFill" class="spot-image"></image>
      <view class="image-badge" wx:if="{{item.imageCount > 1}}">{{item.imageCount}}å¼ </view>
    </view>
    <view class="spot-info">
      <text class="spot-name">{{item.name}}</text>
      <text class="spot-location">{{item.location}}</text>
    </view>
  </view>
</view>
```

## ğŸ’» ç¬¬ä¸‰æ­¥ï¼šé¡µé¢é€»è¾‘ç¤ºä¾‹

### æ™¯ç‚¹å‘å¸ƒé¡µé¢å®Œæ•´é€»è¾‘ (add-spot.js)

```javascript
const ImageApi = require('../../server/ImageApi.js')

Page({
  data: {
    spotId: null,          // æ™¯ç‚¹IDï¼ˆå¿…éœ€ï¼‰
    selectedImages: [],    // é€‰æ‹©çš„å›¾ç‰‡
    spotImages: [],        // å·²ä¸Šä¼ çš„å›¾ç‰‡
    uploading: false       // ä¸Šä¼ çŠ¶æ€
  },

  onLoad(options) {
    // ä»ä¸Šä¸€é¡µè·å–æ™¯ç‚¹ID
    this.setData({ spotId: options.spotId })
    // åŠ è½½å·²æœ‰å›¾ç‰‡
    this.loadSpotImages()
  },

  // é€‰æ‹©å›¾ç‰‡
  async chooseImages() {
    try {
      const res = await wx.chooseMedia({
        count: 9 - this.data.selectedImages.length,
        mediaType: ['image'],
        sourceType: ['album', 'camera'],
        sizeType: ['compressed']  // å‹ç¼©å›¾ç‰‡
      })
      
      // éªŒè¯å›¾ç‰‡
      const validImages = []
      for (const image of res.tempFiles) {
        const validation = ImageApi.validateImageFile(image)
        if (validation.valid) {
          validImages.push(image)
        } else {
          wx.showToast({ title: validation.error, icon: 'none' })
        }
      }
      
      // åˆå¹¶åˆ°å·²é€‰æ‹©çš„å›¾ç‰‡ä¸­
      this.setData({
        selectedImages: [...this.data.selectedImages, ...validImages]
      })
    } catch (error) {
      if (error.errMsg !== 'chooseMedia:fail cancel') {
        console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', error)
      }
    }
  },

  // ç§»é™¤é€‰æ‹©çš„å›¾ç‰‡
  removeImage(event) {
    const index = event.currentTarget.dataset.index
    const selectedImages = this.data.selectedImages
    selectedImages.splice(index, 1)
    this.setData({ selectedImages })
  },

  // ä¸Šä¼ å›¾ç‰‡
  async uploadImages() {
    const { selectedImages, spotId } = this.data
    
    if (!selectedImages.length) {
      wx.showToast({ title: 'è¯·å…ˆé€‰æ‹©å›¾ç‰‡', icon: 'none' })
      return
    }
    
    if (!spotId) {
      wx.showToast({ title: 'è¯·å…ˆä¿å­˜æ™¯ç‚¹ä¿¡æ¯', icon: 'none' })
      return
    }

    this.setData({ uploading: true })

    try {
      const result = await ImageApi.uploadSpotImages(selectedImages, spotId, {
        folderName: 'spots',
        showProgress: true
      })

      if (result.success) {
        // æ¸…ç©ºå·²ä¸Šä¼ çš„å›¾ç‰‡
        this.setData({ selectedImages: [] })
        
        // åˆ·æ–°å›¾ç‰‡åˆ—è¡¨
        await this.loadSpotImages()
        
        wx.showToast({
          title: 'ä¸Šä¼ æˆåŠŸ',
          icon: 'success'
        })
      }
    } catch (error) {
      console.error('ä¸Šä¼ å¤±è´¥:', error)
      wx.showToast({
        title: error.message || 'ä¸Šä¼ å¤±è´¥',
        icon: 'none'
      })
    } finally {
      this.setData({ uploading: false })
    }
  },

  // åŠ è½½æ™¯ç‚¹å›¾ç‰‡
  async loadSpotImages() {
    const { spotId } = this.data
    
    if (!spotId) return

    try {
      const result = await ImageApi.getSpotImages(spotId)
      
      this.setData({ 
        spotImages: result.images,
        imageCount: result.total
      })
    } catch (error) {
      console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error)
    }
  },

  // åˆ é™¤å·²ä¸Šä¼ çš„å›¾ç‰‡
  async deleteImage(event) {
    const fileID = event.currentTarget.dataset.fileid
    
    try {
      await wx.showModal({
        title: 'ç¡®è®¤åˆ é™¤',
        content: 'ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚'
      })
      
      await ImageApi.deleteImage(fileID)
      
      // åˆ·æ–°å›¾ç‰‡åˆ—è¡¨
      await this.loadSpotImages()
    } catch (error) {
      if (error.errMsg !== 'showModal:fail cancel') {
        console.error('åˆ é™¤å¤±è´¥:', error)
      }
    }
  },

  // é¢„è§ˆå›¾ç‰‡
  previewImage(event) {
    const urls = event.currentTarget.dataset.urls
    const current = event.currentTarget.dataset.current
    
    wx.previewImage({
      urls: urls,
      current: current
    })
  }
})
```

### æ™¯ç‚¹è¯¦æƒ…é¡µé¢è½®æ’­å›¾é€»è¾‘ (spot-detail.js)

```javascript
const ImageApi = require('../../server/ImageApi.js')

Page({
  data: {
    spotId: null,
    swiperImages: [],
    currentImageIndex: 0,
    hasImages: false
  },

  onLoad(options) {
    this.setData({ spotId: options.id })
    this.loadSpotImages()
  },

  async loadSpotImages() {
    const { spotId } = this.data
    
    try {
      const result = await ImageApi.getSpotImages(spotId)
      
      if (result.total > 0) {
        this.setData({ 
          swiperImages: result.images,
          hasImages: true
        })
      } else {
        // ä½¿ç”¨é»˜è®¤å›¾ç‰‡
        this.setData({ 
          swiperImages: ['/images/default-spot.jpg'],
          hasImages: false
        })
      }
    } catch (error) {
      console.error('åŠ è½½è½®æ’­å›¾å¤±è´¥:', error)
      // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤å›¾ç‰‡
      this.setData({ 
        swiperImages: ['/images/default-spot.jpg'],
        hasImages: false
      })
    }
  },

  // è½®æ’­å›¾åˆ‡æ¢
  onSwiperChange(event) {
    this.setData({
      currentImageIndex: event.detail.current
    })
  },

  // é¢„è§ˆå›¾ç‰‡
  previewImage(event) {
    if (!this.data.hasImages) return
    
    const urls = event.currentTarget.dataset.urls
    const current = event.currentTarget.dataset.current
    
    wx.previewImage({
      urls: urls,
      current: current
    })
  }
})
```

### æ™¯ç‚¹åˆ—è¡¨é¡µé¢æ‰¹é‡åŠ è½½é€»è¾‘ (spot-list.js)

```javascript
const ImageApi = require('../../server/ImageApi.js')
const SpotApi = require('../../server/SpotApi.js')  // å‡è®¾çš„æ™¯ç‚¹API

Page({
  data: {
    spotList: [],
    loading: false
  },

  onLoad() {
    this.loadSpotList()
  },

  async loadSpotList() {
    this.setData({ loading: true })
    
    try {
      // 1. è·å–æ™¯ç‚¹åˆ—è¡¨
      const spots = await SpotApi.getSpotList()
      
      // 2. æ‰¹é‡é¢„åŠ è½½è½®æ’­å›¾
      const spotIds = spots.map(spot => spot.id)
      const imageMap = await ImageApi.preloadSpotImages(spotIds, {
        concurrent: true,
        maxConcurrent: 5
      })
      
      // 3. ä¸ºæ¯ä¸ªæ™¯ç‚¹æ·»åŠ ä¸»å›¾å’Œå›¾ç‰‡æ•°é‡
      const spotsWithImages = spots.map(spot => ({
        ...spot,
        mainImage: imageMap[spot.id]?.images?.[0] || '/images/default-spot.jpg',
        imageCount: imageMap[spot.id]?.total || 0,
        hasImages: imageMap[spot.id]?.total > 0
      }))
      
      this.setData({ spotList: spotsWithImages })
    } catch (error) {
      console.error('åŠ è½½æ™¯ç‚¹åˆ—è¡¨å¤±è´¥:', error)
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•',
        icon: 'none'
      })
    } finally {
      this.setData({ loading: false })
    }
  },

  // è·³è½¬åˆ°æ™¯ç‚¹è¯¦æƒ…
  goToSpotDetail(event) {
    const spotId = event.currentTarget.dataset.id
    wx.navigateTo({
      url: `/pages/spot-detail/spot-detail?id=${spotId}`
    })
  }
})
```

## ğŸ¨ ç¬¬å››æ­¥ï¼šæ ·å¼å‚è€ƒ (wxss)

### å›¾ç‰‡ä¸Šä¼ åŒºåŸŸæ ·å¼

```css
/* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ */
.image-section {
  padding: 20rpx;
  background: #fff;
  margin-bottom: 20rpx;
}

.section-title {
  font-size: 32rpx;
  font-weight: bold;
  color: #333;
  margin-bottom: 20rpx;
}

/* å·²é€‰æ‹©å›¾ç‰‡é¢„è§ˆ */
.selected-images {
  display: flex;
  flex-wrap: wrap;
  gap: 20rpx;
  margin-bottom: 20rpx;
}

.image-item {
  position: relative;
  width: 200rpx;
  height: 200rpx;
  border-radius: 10rpx;
  overflow: hidden;
}

.image-item image {
  width: 100%;
  height: 100%;
}

.remove-btn {
  position: absolute;
  top: 5rpx;
  right: 5rpx;
  width: 40rpx;
  height: 40rpx;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24rpx;
}

/* é€‰æ‹©å›¾ç‰‡æŒ‰é’® */
.choose-image-btn {
  width: 200rpx;
  height: 200rpx;
  border: 2rpx dashed #ccc;
  border-radius: 10rpx;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #999;
  font-size: 28rpx;
}

.choose-image-btn .iconfont {
  font-size: 60rpx;
  margin-bottom: 10rpx;
}

/* ä¸Šä¼ æŒ‰é’® */
.upload-btn {
  width: 100%;
  background: #007aff;
  color: white;
  border-radius: 10rpx;
  margin-top: 20rpx;
}

.upload-btn[disabled] {
  background: #ccc;
}

/* å·²ä¸Šä¼ å›¾ç‰‡å±•ç¤º */
.uploaded-images {
  margin-top: 40rpx;
}

.image-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 20rpx;
}

.uploaded-item {
  position: relative;
  width: 200rpx;
  height: 200rpx;
  border-radius: 10rpx;
  overflow: hidden;
}

.uploaded-item image {
  width: 100%;
  height: 100%;
}

.delete-btn {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(255, 0, 0, 0.8);
  color: white;
  text-align: center;
  padding: 10rpx;
  font-size: 24rpx;
}
```

### è½®æ’­å›¾æ ·å¼

```css
/* æ™¯ç‚¹è½®æ’­å›¾ */
.spot-swiper {
  width: 100%;
  height: 500rpx;
  position: relative;
}

.swiper-image {
  width: 100%;
  height: 100%;
}

.image-count {
  position: absolute;
  bottom: 20rpx;
  right: 20rpx;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  padding: 10rpx 20rpx;
  border-radius: 20rpx;
  font-size: 24rpx;
}
```

### åˆ—è¡¨é¡µé¢ä¸»å›¾æ ·å¼

```css
/* æ™¯ç‚¹åˆ—è¡¨é¡¹ */
.spot-item {
  display: flex;
  padding: 20rpx;
  background: white;
  margin-bottom: 20rpx;
  border-radius: 10rpx;
}

.spot-image-container {
  position: relative;
  width: 200rpx;
  height: 150rpx;
  border-radius: 10rpx;
  overflow: hidden;
  margin-right: 20rpx;
}

.spot-image {
  width: 100%;
  height: 100%;
}

.image-badge {
  position: absolute;
  top: 10rpx;
  right: 10rpx;
  background: rgba(0, 0, 0, 0.6);
  color: white;
  padding: 5rpx 10rpx;
  border-radius: 15rpx;
  font-size: 20rpx;
}

.spot-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.spot-name {
  font-size: 32rpx;
  font-weight: bold;
  color: #333;
  margin-bottom: 10rpx;
}

.spot-location {
  font-size: 28rpx;
  color: #666;
}
```

## âš¡ ç¬¬äº”æ­¥ï¼šæ€§èƒ½ä¼˜åŒ–æŠ€å·§

### 1. å›¾ç‰‡æ‡’åŠ è½½ï¼ˆåˆ—è¡¨é¡µé¢ï¼‰

```javascript
// ä½¿ç”¨Intersection Observerå®ç°å›¾ç‰‡æ‡’åŠ è½½
Page({
  data: {
    spotList: []
  },

  onReady() {
    this.createIntersectionObserver()
  },

  createIntersectionObserver() {
    const observer = this.createIntersectionObserver({
      threshold: 0.1
    })
    
    observer.relativeToViewport()
    observer.observe('.spot-item', (res) => {
      if (res.intersectionRatio > 0) {
        // è¿›å…¥è§†å›¾æ—¶åŠ è½½å›¾ç‰‡
        const dataset = res.dataset
        if (dataset.spotId && !dataset.loaded) {
          this.loadSpotMainImage(dataset.spotId, dataset.index)
        }
      }
    })
  },

  async loadSpotMainImage(spotId, index) {
    try {
      const mainImage = await ImageApi.getSpotMainImage(spotId, '/images/default-spot.jpg')
      const key = `spotList[${index}].mainImage`
      const loadedKey = `spotList[${index}].loaded`
      
      this.setData({
        [key]: mainImage,
        [loadedKey]: true
      })
    } catch (error) {
      console.error('åŠ è½½ä¸»å›¾å¤±è´¥:', error)
    }
  }
})
```

### 2. å›¾ç‰‡ç¼“å­˜ä¼˜åŒ–

```javascript
// åœ¨app.jsä¸­å®ç°å›¾ç‰‡ç¼“å­˜
App({
  globalData: {
    imageCache: new Map(),
    cacheSize: 0,
    maxCacheSize: 50 * 1024 * 1024  // 50MB
  },

  // è·å–ç¼“å­˜çš„å›¾ç‰‡
  getCachedImage(url) {
    return this.globalData.imageCache.get(url)
  },

  // ç¼“å­˜å›¾ç‰‡
  setCachedImage(url, localPath, size) {
    if (this.globalData.cacheSize + size > this.globalData.maxCacheSize) {
      this.clearOldCache()
    }
    
    this.globalData.imageCache.set(url, {
      localPath,
      size,
      timestamp: Date.now()
    })
    this.globalData.cacheSize += size
  }
})
```

## ğŸ”§ å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### 1. å›¾ç‰‡ä¸Šä¼ å¤±è´¥

```javascript
// æ·»åŠ é‡è¯•æœºåˆ¶
async function uploadWithRetry(images, spotId, options = {}, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await ImageApi.uploadSpotImages(images, spotId, options)
    } catch (error) {
      console.error(`ä¸Šä¼ å¤±è´¥ï¼Œç¬¬${i + 1}æ¬¡é‡è¯•:`, error)
      
      if (i === maxRetries - 1) {
        throw error
      }
      
      // ç­‰å¾…1ç§’åé‡è¯•
      await new Promise(resolve => setTimeout(resolve, 1000))
    }
  }
}
```

### 2. å›¾ç‰‡åŠ è½½æ…¢

```javascript
// æ·»åŠ å›¾ç‰‡é¢„åŠ è½½
function preloadImages(urls) {
  return Promise.all(urls.map(url => {
    return new Promise((resolve) => {
      const img = wx.createImage()
      img.onload = resolve
      img.onerror = resolve
      img.src = url
    })
  }))
}
```

### 3. å†…å­˜ç®¡ç†

```javascript
// é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
Page({
  onUnload() {
    // æ¸…ç†å¤§å›¾ç‰‡æ•°æ®
    this.setData({
      selectedImages: [],
      spotImages: []
    })
  }
})
```

## âœ… é›†æˆæ£€æŸ¥æ¸…å•

- [ ] å·²å¯¼å…¥ `ImageApi` æ¨¡å—
- [ ] é¡µé¢åŒ…å«å›¾ç‰‡é€‰æ‹©åŠŸèƒ½
- [ ] é¡µé¢åŒ…å«å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½  
- [ ] é¡µé¢åŒ…å«å›¾ç‰‡å±•ç¤ºåŠŸèƒ½
- [ ] æ·»åŠ äº†é€‚å½“çš„é”™è¯¯å¤„ç†
- [ ] æ·»åŠ äº†åŠ è½½çŠ¶æ€æç¤º
- [ ] å®ç°äº†å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
- [ ] æ ·å¼ç¾è§‚ä¸”å“åº”å¼
- [ ] è€ƒè™‘äº†æ€§èƒ½ä¼˜åŒ–
- [ ] æµ‹è¯•äº†å®Œæ•´æµç¨‹

---

æ­å–œï¼æ‚¨å·²ç»æˆåŠŸé›†æˆäº†å›¾ç‰‡ç®¡ç†åŠŸèƒ½ã€‚å¦‚éœ€æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è€ƒã€Šå›¾ç‰‡ç®¡ç†APIä½¿ç”¨æŒ‡å—ã€‹ã€‚
