# è¯„è®ºåŠŸèƒ½å¿«é€Ÿé›†æˆæŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ–‡ä»¶å‡†å¤‡

ç¡®ä¿æ‚¨çš„é¡¹ç›®ä¸­åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š

```
miniprogram/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ CommentApi.js                    # âœ… è¯„è®ºAPIæ ¸å¿ƒæ–‡ä»¶
â”‚   â”œâ”€â”€ è¯„è®ºç®¡ç†APIä½¿ç”¨æŒ‡å—.md              # ğŸ“– è¯¦ç»†ä½¿ç”¨è¯´æ˜
â”‚   â”œâ”€â”€ CommentApiTestExample.js         # ğŸ§ª æµ‹è¯•é¡µé¢JSç¤ºä¾‹
â”‚   â”œâ”€â”€ CommentApiTestExample.wxml       # ğŸ§ª æµ‹è¯•é¡µé¢WXMLç¤ºä¾‹
â”‚   â””â”€â”€ CommentApiTestExample.wxss       # ğŸ§ª æµ‹è¯•é¡µé¢æ ·å¼ç¤ºä¾‹
â””â”€â”€ cloudfunctions/
    â””â”€â”€ commonManager/
        â””â”€â”€ index.js                     # âœ… è¯„è®ºç®¡ç†äº‘å‡½æ•°
```

### 2. ä¸€åˆ†é’Ÿé›†æˆ

#### æ­¥éª¤1: å¼•å…¥APIæ–‡ä»¶
```javascript
// åœ¨éœ€è¦ä½¿ç”¨è¯„è®ºåŠŸèƒ½çš„é¡µé¢ä¸­
const CommentApi = require('../../server/CommentApi.js')
```

#### æ­¥éª¤2: åŸºç¡€åŠŸèƒ½é›†æˆ
```javascript
Page({
  data: {
    spotId: 1,
    comments: []
  },

  onLoad() {
    this.loadComments()
  },

  // åŠ è½½è¯„è®º
  async loadComments() {
    const result = await CommentApi.getCommentsBySpot({
      spot_id: this.data.spotId,
      page: 1,
      limit: 10
    })

    if (result.success) {
      this.setData({
        comments: CommentApi.formatCommentsForDisplay(result.data)
      })
    }
  },

  // æ·»åŠ è¯„è®º
  async addComment(commentText) {
    const result = await CommentApi.addComment({
      common: commentText,
      spot_id: this.data.spotId,
      person: wx.getStorageSync('openid')
    })

    if (result.success) {
      wx.showToast({ title: 'è¯„è®ºæˆåŠŸ', icon: 'success' })
      this.loadComments() // åˆ·æ–°åˆ—è¡¨
    }
  }
})
```

#### æ­¥éª¤3: WXMLåŸºç¡€æ¨¡æ¿
```xml
<!-- è¯„è®ºåˆ—è¡¨æ˜¾ç¤º -->
<view wx:for="{{comments}}" wx:key="id" class="comment-item">
  <text class="comment-content">{{item.content}}</text>
  <text class="comment-time">{{item.createTimeText}}</text>
</view>

<!-- è¯„è®ºè¾“å…¥ -->
<input placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." bindinput="onCommentInput" />
<button bindtap="submitComment">å‘å¸ƒ</button>
```

### 3. æ ¸å¿ƒAPIå¿«è§ˆ

| åŠŸèƒ½ | æ–¹æ³• | å‚æ•° | è¿”å›å€¼ |
|------|------|------|--------|
| æ·»åŠ è¯„è®º | `CommentApi.addComment(data)` | `{common, spot_id, person}` | `{success, data, message}` |
| è·å–æ™¯ç‚¹è¯„è®º | `CommentApi.getCommentsBySpot(options)` | `{spot_id, page, limit}` | `{success, data, total}` |
| æ›´æ–°è¯„è®º | `CommentApi.updateComment(data)` | `{_id, common}` | `{success, data, message}` |
| åˆ é™¤è¯„è®º | `CommentApi.deleteComment(id)` | `commentId` | `{success, data, message}` |
| æ ¼å¼åŒ–æ˜¾ç¤º | `CommentApi.formatCommentsForDisplay(comments)` | `Array` | `Array` |

### 4. å¸¸ç”¨åœºæ™¯ç¤ºä¾‹

#### æ™¯ç‚¹è¯¦æƒ…é¡µé›†æˆè¯„è®ºåŠŸèƒ½
```javascript
// pages/spot-detail/spot-detail.js
const CommentApi = require('../../server/CommentApi.js')

Page({
  data: {
    spot: {},
    comments: [],
    commentInput: ''
  },

  onLoad(options) {
    this.loadSpotDetail(options.id)
    this.loadComments(options.id)
  },

  async loadComments(spotId) {
    const result = await CommentApi.getCommentsBySpot({
      spot_id: parseInt(spotId),
      page: 1,
      limit: 20
    })

    if (result.success) {
      this.setData({
        comments: CommentApi.formatCommentsForDisplay(result.data)
      })
    }
  },

  onCommentInput(e) {
    this.setData({ commentInput: e.detail.value })
  },

  async submitComment() {
    if (!this.data.commentInput.trim()) {
      wx.showToast({ title: 'è¯·è¾“å…¥è¯„è®ºå†…å®¹', icon: 'error' })
      return
    }

    const result = await CommentApi.addComment({
      common: this.data.commentInput.trim(),
      spot_id: this.data.spot.id,
      person: wx.getStorageSync('openid') || 'anonymous'
    })

    if (result.success) {
      wx.showToast({ title: 'è¯„è®ºæˆåŠŸ', icon: 'success' })
      this.setData({ commentInput: '' })
      this.loadComments(this.data.spot.id)
    } else {
      wx.showToast({ title: result.message, icon: 'error' })
    }
  }
})
```

### 5. æ ·å¼æ¨¡æ¿

#### ç®€çº¦è¯„è®ºå¡ç‰‡æ ·å¼
```css
.comment-item {
  background: white;
  margin: 20rpx;
  padding: 30rpx;
  border-radius: 16rpx;
  box-shadow: 0 2rpx 12rpx rgba(0,0,0,0.1);
}

.comment-content {
  font-size: 30rpx;
  line-height: 1.6;
  color: #333;
  margin-bottom: 20rpx;
}

.comment-meta {
  display: flex;
  justify-content: space-between;
  font-size: 24rpx;
  color: #999;
}
```

### 6. é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

```javascript
async function handleCommentAction(apiCall) {
  try {
    wx.showLoading({ title: 'å¤„ç†ä¸­...' })
    
    const result = await apiCall()
    
    wx.hideLoading()
    
    if (result.success) {
      // æˆåŠŸå¤„ç†
      return result
    } else {
      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      wx.showToast({
        title: result.message,
        icon: 'error'
      })
      return null
    }
  } catch (error) {
    wx.hideLoading()
    wx.showToast({
      title: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•',
      icon: 'error'
    })
    console.error('è¯„è®ºæ“ä½œå¤±è´¥:', error)
    return null
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const result = await handleCommentAction(async () => {
  return CommentApi.addComment(commentData)
})
```

### 7. æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### è¯„è®ºåˆ—è¡¨è™šæ‹ŸåŒ–ï¼ˆé•¿åˆ—è¡¨ä¼˜åŒ–ï¼‰
```javascript
data: {
  comments: [],
  page: 1,
  hasMore: true,
  loading: false
},

async loadMoreComments() {
  if (this.data.loading || !this.data.hasMore) return
  
  this.setData({ loading: true })
  
  const result = await CommentApi.getCommentsBySpot({
    spot_id: this.data.spotId,
    page: this.data.page,
    limit: 10
  })
  
  if (result.success) {
    const newComments = CommentApi.formatCommentsForDisplay(result.data)
    this.setData({
      comments: [...this.data.comments, ...newComments],
      page: this.data.page + 1,
      hasMore: newComments.length === 10
    })
  }
  
  this.setData({ loading: false })
}
```

### 8. å¸¸è§é—®é¢˜è§£å†³

#### Q: è¯„è®ºæäº¤åä¸æ˜¾ç¤ºï¼Ÿ
A: æ£€æŸ¥æ•°æ®æ ¼å¼å’Œæƒé™è®¾ç½®
```javascript
// ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
const commentData = {
  common: "è¯„è®ºå†…å®¹",        // å­—ç¬¦ä¸²
  spot_id: 1,              // æ•°å­—
  person: "openid"         // å­—ç¬¦ä¸²
}

// ç¡®ä¿ç”¨æˆ·å·²ç™»å½•
const openid = wx.getStorageSync('openid')
if (!openid) {
  // å…ˆè®©ç”¨æˆ·ç™»å½•
  wx.navigateTo({ url: '/pages/login/login' })
  return
}
```

#### Q: äº‘å‡½æ•°è°ƒç”¨å¤±è´¥ï¼Ÿ
A: æ£€æŸ¥äº‘å‡½æ•°éƒ¨ç½²å’Œæƒé™
```javascript
// æµ‹è¯•äº‘å‡½æ•°è¿æ¥
const testResult = await CommentApi.testConnection()
console.log('è¿æ¥æµ‹è¯•:', testResult)
```

### 9. å®Œæ•´åŠŸèƒ½æ¸…å•

- âœ… æ·»åŠ è¯„è®º
- âœ… åˆ é™¤è¯„è®º  
- âœ… æ›´æ–°è¯„è®º
- âœ… è·å–è¯„è®ºåˆ—è¡¨
- âœ… æŒ‰æ™¯ç‚¹ç­›é€‰è¯„è®º
- âœ… åˆ†é¡µåŠ è½½
- âœ… æ•°æ®éªŒè¯
- âœ… é”™è¯¯å¤„ç†
- âœ… æ—¶é—´æ ¼å¼åŒ–
- âœ… æ•°æ®æ ¼å¼åŒ–
- âœ… æµ‹è¯•è¿æ¥

### 10. ä¸‹ä¸€æ­¥

1. **éƒ¨ç½²äº‘å‡½æ•°**: ç¡®ä¿ `commonManager` äº‘å‡½æ•°å·²æ­£ç¡®éƒ¨ç½²
2. **æµ‹è¯•åŠŸèƒ½**: ä½¿ç”¨æä¾›çš„æµ‹è¯•é¡µé¢éªŒè¯åŠŸèƒ½
3. **é›†æˆåˆ°é¡¹ç›®**: æ ¹æ®éœ€æ±‚é›†æˆåˆ°å…·ä½“é¡µé¢
4. **æ ·å¼å®šåˆ¶**: æ ¹æ®è®¾è®¡è§„èŒƒè°ƒæ•´æ ·å¼
5. **æ€§èƒ½ä¼˜åŒ–**: æ ¹æ®æ•°æ®é‡è€ƒè™‘åˆ†é¡µå’Œç¼“å­˜ç­–ç•¥

---

ğŸ’¡ **æç¤º**: å¦‚éœ€æ›´è¯¦ç»†çš„è¯´æ˜ï¼Œè¯·æŸ¥çœ‹ `è¯„è®ºç®¡ç†APIä½¿ç”¨æŒ‡å—.md` æ–‡ä»¶
